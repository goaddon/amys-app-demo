<div class="text-center mt-5">
	<div class="row mb-4">
		<div class="col-sm-0 col-md-1 col-lg-2 col-xl-3">
		</div>
		<div class="col-sm-12 col-md-10 col-lg-8 col-xl-6 bg-light p-4">
			<h1 class="display-3" id="variants_count">{{ variants_count }}</h1>
			<h1 class="display-4" id="job_status">
				{% if variants_count == 1 %}
					{{ l.product }}
				{% else %}
					{{ l.products }}
				{% endif %}
				&nbsp;{{ l.out_of_stock }}
			</h1>
		</div>
		<div class="col-sm-0 col-md-1 col-lg-2	col-xl-3">
		</div>
	</div>
	<button type="button" class="btn btn-outline-primary btn-lg ml-2 compare-suppliers">{{ l.compare }}</button>
	<script>
		var checkCreateItems, checkOrderItems, createItems, getTimeout, itemOrderUrl, jobUrl, orderItems;

		jobUrl = function() {
			return "{{ 'jobs__show' | path_for: id: 'id_placeholder' }}.json";
		};

		itemOrderUrl = function() {
			return "{{ 'item_orders__show' | path_for: id: 'id_placeholder' }}";
		};

		getTimeout = function(timeout) {
			return Math.min(60000, timeout);
		};

		checkOrderItems = function(job_id, timeout) {
			return setTimeout((function() {
				timeout = getTimeout(timeout);
				return $.ajax({
					type: "get",
					dataType: "json",
					url: jobUrl().replace("id_placeholder", job_id),
					success: function(data, status, xhr) {
						if (data !== null) {
							if (data.job_status === null || data.job_status === "in_progress") {
								$("#job_status").html("{{ l.ordering_items }}");
								return checkOrderItems(job_id, timeout + 20);
							} else if (data.job_status === "erred") {
								return $("#job_status").html("{{ l.erred_ordering_items }}: " + data.error_message);
							} else if (data.job_status === "finished") {
								return location.href = itemOrderUrl().replace("id_placeholder", job_id);
							}
						}
					}
				});
			}), timeout);
		};

		orderItems = function(timeout) {
			return setTimeout((function() {
				timeout = getTimeout(timeout);
				return $.ajax({
					type: "post",
					dataType: "json",
					url: "{{ 'item_orders__create' | path_for }}.json",
					success: function(data, status, xhr) {
						if (data !== null) {
							if (data.error_message !== undefined) {
								return $("#job_status").html("{{ l.did_not_order_items }}: " + data.error_message);
							} else if (data.job_id !== undefined) {
								$("#job_status").html("{{ l.ordering_items }}");
								return checkOrderItems(data.job_id, 500);
							}
						}
					}
				});
			}), timeout);
		};

		checkCreateItems = function(job_id, timeout) {
			return setTimeout((function() {
				timeout = getTimeout(timeout);
				return $.ajax({
					type: "get",
					dataType: "json",
					url: jobUrl().replace("id_placeholder", job_id),
					success: function(data, status, xhr) {
						if (data !== null) {
							if (data.job_status === null || data.job_status === "in_progress") {
								$("#job_status").html("{{ l.getting_items }}");
								return checkCreateItems(job_id, timeout + 20);
							} else if (data.job_status === "finished") {
								$("#job_status").html("{{ l.got_items }}");
								return orderItems(500);
							}
						}
					}
				});
			}), timeout);
		};

		createItems = function() {
			$(".compare-suppliers").hide();
			return $.ajax({
				type: "post",
				dataType: "json",
				url: "{{ 'items__create' | path_for }}.json",
				success: function(data, status, xhr) {
					if (data !== null) {
						$("#variants_count").remove();
						if (data.error_message !== undefined) {
							return $("#job_status").html("{{ l.items_not_created }}: " + data.error_message);
						} else if (data.job_id !== undefined) {
							$("#job_status").html("{{ l.creating_items }}");
							return checkCreateItems(data.job_id, 500);
						}
					}
				}
			});
		};

		$(".compare-suppliers").off("click");

		$(".compare-suppliers").click(function(e) {
			return createItems();
		});
	</script>
</div>